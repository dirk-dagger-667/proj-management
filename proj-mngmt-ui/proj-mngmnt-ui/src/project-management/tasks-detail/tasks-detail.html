<mat-card class="task-details-card">
  <mat-card-header>
    <mat-card-title>Task Details</mat-card-title>

    @if (task()) {
    <mat-card-subtitle>{{ task()?.title }}</mat-card-subtitle>
    }
  </mat-card-header>
  <mat-card-content>
    @if (task(); as task) {
    <form [formGroup]="taskForm" (ngSubmit)="saveTask()">
      <div class="form-grid">
        <mat-form-field>
          <mat-label>Task Type</mat-label>
          <mat-select formControlName="type" required>
            @for (type of taskTypes; track type) {
            <mat-option [value]="type">{{ type }}</mat-option>
            }
          </mat-select>
          @if (taskForm.get('type')?.hasError('required')) {
          <mat-error>Type is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Title</mat-label>
          <input matInput formControlName="title" required />
          @if (taskForm.get('title')?.hasError('required')) {
          <mat-error>Title is required</mat-error>
          } @if (taskForm.get('title')?.hasError('minlength')) {
          <mat-error>Title must be at least 3 characters</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description"></textarea>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Assignee</mat-label>
          <input matInput formControlName="assignee" />
          @if (taskForm.get('assignee')?.hasError('email')) {
          <mat-error>Invalid email format</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Priority</mat-label>
          <mat-select formControlName="priority" required>
            @for (priority of priorities; track priority) {
            <mat-option [value]="priority">{{ priority }}</mat-option>
            }
          </mat-select>
          @if (taskForm.get('priority')?.hasError('required')) {
          <mat-error>Priority is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Status</mat-label>
          <mat-select formControlName="status" required>
            @for (status of statuses; track status) {
            <mat-option [value]="status">{{ status }}</mat-option>
            }
          </mat-select>
          @if (taskForm.get('status')?.hasError('required')) {
          <mat-error>Status is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Estimate (hours)</mat-label>
          <input matInput type="number" formControlName="estimate" required />
          @if (taskForm.get('estimate')?.hasError('required')) {
          <mat-error>Estimate is required</mat-error>
          } @if (taskForm.get('estimate')?.hasError('min')) {
          <mat-error>Estimate must be non-negative</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Created At</mat-label>
          <input matInput [matDatepicker]="createdAtPicker" formControlName="createdAt" required />
          @if (taskForm.get('createdAt')?.hasError('required')) {
          <mat-error>Created At is required</mat-error>
          }
          <mat-datepicker #createdAtPicker></mat-datepicker>
        </mat-form-field>

        <mat-card-actions>
          <button mat-raised-button color="primary" type="submit" [disabled]="!taskForm.valid">
            Save
          </button>
          <a mat-button routerLink="/projects">Back to Projects</a>
        </mat-card-actions>
      </div>
    </form>

    <h3>Audit History</h3>
    <table mat-table [dataSource]="audits()">
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let audit">{{ audit.id }}</td>
      </ng-container>
      <ng-container matColumnDef="auditType">
        <th mat-header-cell *matHeaderCellDef>Type</th>
        <td mat-cell *matCellDef="let audit">{{ audit.auditType }}</td>
      </ng-container>
      <ng-container matColumnDef="metadata">
        <th mat-header-cell *matHeaderCellDef>Metadata</th>
        <td mat-cell *matCellDef="let audit">{{ audit.metadata }}</td>
      </ng-container>
      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef>Created At</th>
        <td mat-cell *matCellDef="let audit">{{ audit.createdAt | date : 'medium' }}</td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <mat-paginator
      [length]="auditsCount()"
      [pageSize]="pageSize()"
      aria-label="Select page of GitHub search results"
    ></mat-paginator>
    @if (loading()) {
    <mat-spinner diameter="40"></mat-spinner>
    } } @else {
    <mat-spinner></mat-spinner>
    <p>Loading task...</p>
    }
  </mat-card-content>
</mat-card>
